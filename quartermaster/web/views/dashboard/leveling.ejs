<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leveling - <%= guild.name %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="dashboard-container">
        <div class="container">
            <div class="breadcrumb">
                <a href="/dashboard">Dashboard</a> /
                <a href="/dashboard/server/<%= guild.id %>"><%= guild.name %></a> /
                <span>Leveling</span>
            </div>

            <h1>Leveling Settings</h1>

            <div class="settings-section">
                <h2>General Settings</h2>
                <form id="levelingForm">
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" name="enabled" <%= config.leveling.enabled ? 'checked' : '' %>>
                            <span class="toggle-slider"></span>
                            Enable Leveling System
                        </label>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Minimum XP per Message</label>
                            <input type="number" name="xpMin" value="<%= config.leveling.xpPerMessage.min %>" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label>Maximum XP per Message</label>
                            <input type="number" name="xpMax" value="<%= config.leveling.xpPerMessage.max %>" min="1" max="100">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>XP Cooldown (seconds)</label>
                        <input type="number" name="cooldown" value="<%= config.leveling.cooldown %>" min="0" max="3600">
                        <small>Time users must wait between gaining XP</small>
                    </div>

                    <div class="form-group">
                        <label>Level Up Message</label>
                        <input type="text" name="levelUpMessage" value="<%= config.leveling.levelUpMessage %>">
                        <small>Use {user} for mention, {level} for level number</small>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </form>
            </div>

            <div class="settings-section">
                <h2>Role Rewards</h2>
                <p>Automatically give roles when members reach certain levels</p>

                <div class="role-rewards-list">
                    <% Object.entries(config.leveling.roleRewards).forEach(([level, roleId]) => {
                        const role = roles.find(r => r.id === roleId || r.name === roleId);
                    %>
                        <div class="role-reward-item">
                            <span>Level <%= level %></span>
                            <span class="role-badge" style="background-color: <%= role ? '#' + role.color.toString(16).padStart(6, '0') : '#99AAB5' %>">
                                <%= role ? role.name : roleId %>
                            </span>
                            <button class="btn btn-small btn-danger" onclick="removeRoleReward(<%= level %>)">Remove</button>
                        </div>
                    <% }); %>
                </div>

                <form id="addRoleRewardForm" class="form-inline">
                    <div class="form-group">
                        <label>Level</label>
                        <input type="number" name="level" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select name="roleId" required>
                            <option value="">Select a role...</option>
                            <% roles.forEach(role => { %>
                                <option value="<%= role.id %>"><%= role.name %></option>
                            <% }); %>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Role Reward</button>
                </form>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <%- include('../partials/footer') %>

    <script>
        const guildId = '<%= guild.id %>';

        // Handle leveling form submission
        document.getElementById('levelingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const response = await fetch(`/api/server/${guildId}/leveling`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    enabled: formData.get('enabled') === 'on',
                    xpMin: formData.get('xpMin'),
                    xpMax: formData.get('xpMax'),
                    cooldown: formData.get('cooldown'),
                    levelUpMessage: formData.get('levelUpMessage')
                })
            });

            const data = await response.json();
            showNotification(data.message, response.ok ? 'success' : 'error');
        });

        // Handle add role reward form
        document.getElementById('addRoleRewardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const response = await fetch(`/api/server/${guildId}/leveling/role-reward`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    level: formData.get('level'),
                    roleId: formData.get('roleId')
                })
            });

            const data = await response.json();
            showNotification(data.message, response.ok ? 'success' : 'error');

            if (response.ok) {
                setTimeout(() => location.reload(), 1000);
            }
        });

        // Remove role reward
        async function removeRoleReward(level) {
            if (!confirm(`Remove role reward for level ${level}?`)) return;

            const response = await fetch(`/api/server/${guildId}/leveling/role-reward/${level}`, {
                method: 'DELETE'
            });

            const data = await response.json();
            showNotification(data.message, response.ok ? 'success' : 'error');

            if (response.ok) {
                setTimeout(() => location.reload(), 1000);
            }
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification notification-${type} show`;
            setTimeout(() => notification.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
